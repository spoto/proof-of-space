\section{Nonces and Plots}\label{sec:nonces_and_plots}

This section formalizes the notion of nonce and plot, together with their
algorithmic construction. Tab.~\ref{tab:notations} collects some notations,
introduced here and used throughout the paper.
It also reports the specific choices
made in~\cite{SignumPlotting} for such notations, but this paper remains parametric
\wrt them.

\begin{table}[t]
\begin{center}
\begin{tabular}{|c|c|c|}
  \hline
  \textbf{notation} & \textbf{meaning} & \textbf{in~\cite{SignumPlotting}}\\\hline\hline

  $\append$ & concatenation on sequences & \\\hline
  $\numberofscoops$ & number of scoops contained in a nonce & $4096$\\\hline

  $h_\deadline$ & hashing function for computing nonces, plots and deadlines & shabal256\\\hline

  $h_\generation$ & hashing function for computing the generations of challenges & shabal256\\\hline

  $\kappa$ & maximal number of bytes fed to $h_\deadline$ & $4096$\\\hline

\end{tabular}
\end{center}
\caption{Notations used in our formalization and their specific instantiations
  used in~\cite{SignumPlotting}.}
\label{tab:notations}
\end{table}
%
\begin{definition}[Concatenation operator $\bowtie$]
  Sequences are concatenated by $\bowtie$. The same $\bowtie$
  is used to concated a sequence to a element or an element to a sequence.
\end{definition}
%
\begin{definition}[$\nattobe$ and $\betonat$]
  The operators $\nattobe$ and $\betonat$ transform natural numbers
  into their big-endian representation, and vice versa.
\end{definition}
%
\begin{definition}[Hashing function]
  A \emph{hashing function} $h$ of $\size>0$
  is a total map $h:\mathit{byte}^*\to\mathit{byte}^\size$, where
  $\mathit{byte}^\size$ is a sequence of $\size$ bytes, called a \emph{hash} for $h$.
  If $h$ is a hashing function, then $\size(h)$ is its size.
\end{definition}
%
The definition of nonces and plots is parametric \wrt a hashing
function $h_\deadline$ used for their creation.
A \emph{scoop} is a pair of hashes.
A \emph{nonce} is a non-negative \emph{progressive number} $p$, and
a list of $\numberofscoops>0$ scoops or, equivalenty,
a list of $2\times\numberofscoops$ hashes for $h_\deadline$.
%
\begin{definition}[Scoop, Nonce]
  The sets of \emph{scoops} and \emph{nonces} are
  \[
  \Scoops=\left\{\langle h_1,h_2\rangle\left|\begin{array}{l}
  h_1,h_2\text{ are hashes for }h_\deadline
  \end{array}\right.\right\},
  \]
  \[
  \Nonces=\left\{\langle p,\scoops\rangle\left|\begin{array}{l}
  p\in\mathbb{N}\text{ and }\scoops\in\Scoops^\numberofscoops
  \end{array}\right.\right\}.
  \]
\end{definition}
%
A \emph{prolog} is the identifier of the creator of nonces and plots.
For now, it is just a sequence of bytes. Later, we will give structure to prologs
and see how they can be useful.
%
\begin{definition}[Prolog]\label{def:prolog}
  The set of \emph{prologs} is
  \[
  \Prologs=\{\pi\mid\pi\in\mathit{bytes}^*\}.
  \]
\end{definition}
%
The following algorithm constructs a nonce, given its progressive number and a prolog.
It uses a constant $\kappa>0$ to limit its computational cost, hence avoiding to hash
very large chunks of data.
%
\begin{alg}[$\nonce(p,\pi)$]\label{alg:nonce_construction}
  Given $p\in\mathbb{N}$ and $\pi\in\Prologs$, let
  \[
  \nonce(p,\pi)=\langle p,\langle h_0,h_1\rangle\append
  \cdots\append\langle h_{2\times\numberofscoops-2},h_{2\times\numberofscoops-1}\rangle\rangle\in\Nonces,
  \]
  where the hashes $h_0,\ldots,h_{2\times\numberofscoops-1}$ are constructed as follows.
  %
  \begin{enumerate}
  \item Let $\seed=\pi\append\nattobe(p)$.
  \item For each $i$ from $2\times\numberofscoops-1$ to $0$,
    let\footnote{In~\cite{SignumPlotting}, it is said to
    take the \emph{last} $\kappa$ bytes, but an inspection of their code
    shows that they actually take the \emph{first} $\kappa$ bytes. They
    probably use \emph{last} here in the sense of \emph{more recently computed}.}
    \[
    h_i=h_\deadline\left(\text{first $\kappa$ bytes of}\left(\left(\append_{i<j<2\times\numberofscoops}h_j\right)\append\seed\right)\right).
    \]
  \item Let
    \[
    \finalhash=h_\deadline\left(\left(\append_{0\le j<2\times\numberofscoops}h_j\right)\append\seed\right).
    \]
  \item For each $i$ from $0$ to $2\times\numberofscoops-1$, reassign
    $h_i$ to $h_i\xor\finalhash$.
  \item For each odd $i$ from $1$ to $2\times\numberofscoops-1$, swap
    $h_i$ with $h_{2\times\numberofscoops-i}$.
  \end{enumerate}
\end{alg}
%
A \emph{plot} is a set of nonces constructed with Alg.~\ref{alg:nonce_construction},
for a finite non-empty set of progressive numbers $P$ and
for a given prolog $\pi$, recorded in the plot.
%
\begin{definition}[Plot]\label{def:plot}
  The set of \emph{plots} is defined as
  \[
  \Plots=\left\{\left<\pi,\nonces\right>\left|\begin{array}{l}
  \pi\in\Prologs,\ \varnothing\not=P\subset\mathbb{N}\text{ is finite}\\
  \text{and }\nonces=\left\{\nonce(p,\pi)\left|\;p\in P\right.\right\}
  \end{array}\right.\right\}.
  \]
\end{definition}
